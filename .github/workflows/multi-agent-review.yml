name: Multi-Agent Code Review Automation

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  trigger-reviewers:
    name: Trigger Review Bots
    runs-on: ubuntu-latest
    outputs:
      trigger_timestamp: ${{ steps.set-timestamp.outputs.timestamp }}
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          fetch-depth: 0

      - name: Set trigger timestamp
        id: set-timestamp
        run: echo "timestamp=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_OUTPUT

      - name: Trigger BugBot review
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: '@BugBot, review'
            });
            console.log('Posted BugBot trigger comment');

      - name: Trigger ChatGPT Codex review
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: '@codex, review'
            });
            console.log('Posted Codex trigger comment');

      - name: Log trigger info
        run: |
          echo "Triggered review bots at: ${{ steps.set-timestamp.outputs.timestamp }}"
          echo "PR #${{ github.event.pull_request.number }}"
          echo "Waiting for bot responses..."

  collect-feedback:
    name: Collect Bot Feedback
    runs-on: ubuntu-latest
    needs: trigger-reviewers
    outputs:
      feedback_json: ${{ steps.aggregate.outputs.feedback_json }}
      feedback_summary: ${{ steps.aggregate.outputs.feedback_summary }}
      has_issues: ${{ steps.aggregate.outputs.has_issues }}
      bot_count: ${{ steps.aggregate.outputs.bot_count }}
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          cd .github/scripts
          npm init -y
          npm install @actions/core @actions/github

      - name: Wait for initial bot processing (10 minutes)
        run: |
          echo "Waiting 10 minutes for bots to process..."
          sleep 600

      - name: Poll for bot responses (up to 5 minutes)
        id: poll
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO_OWNER: ${{ github.repository_owner }}
          REPO_NAME: ${{ github.event.repository.name }}
          SINCE_TIMESTAMP: ${{ needs.trigger-reviewers.outputs.trigger_timestamp }}
        run: |
          echo "Polling for bot responses..."
          max_polls=10  # 5 minutes (30s intervals)
          poll_count=0

          while [ $poll_count -lt $max_polls ]; do
            # Quick check if any bots have responded
            bot_count=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
              "https://api.github.com/repos/$REPO_OWNER/$REPO_NAME/issues/$PR_NUMBER/comments?since=$SINCE_TIMESTAMP" \
              | jq '[.[] | select(.user.login | test("\\[bot\\]$|^copilot$"))] | length')

            echo "Poll $((poll_count + 1))/$max_polls: $bot_count bots responded"

            if [ "$bot_count" -ge 2 ]; then
              echo "Sufficient bot responses detected"
              break
            fi

            poll_count=$((poll_count + 1))
            if [ $poll_count -lt $max_polls ]; then
              sleep 30
            fi
          done

          echo "Polling complete. Proceeding with available feedback..."

      - name: Aggregate bot reviews
        id: aggregate
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO_OWNER: ${{ github.repository_owner }}
          REPO_NAME: ${{ github.event.repository.name }}
          SINCE_TIMESTAMP: ${{ needs.trigger-reviewers.outputs.trigger_timestamp }}
        run: node .github/scripts/aggregate-reviews.js

      - name: Log collection summary
        run: |
          echo "=== Collection Summary ==="
          echo "Bots responded: ${{ steps.aggregate.outputs.bot_count }}"
          echo "Has issues: ${{ steps.aggregate.outputs.has_issues }}"
          echo ""
          echo "${{ steps.aggregate.outputs.feedback_summary }}"

  detect-changes:
    name: Detect New Issues
    runs-on: ubuntu-latest
    needs: collect-feedback
    outputs:
      should_fix: ${{ steps.compare.outputs.should_fix }}
      result: ${{ steps.compare.outputs.result }}
      reason: ${{ steps.compare.outputs.reason }}
      current_hash: ${{ steps.compare.outputs.current_hash }}
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          cd .github/scripts
          npm init -y
          npm install @actions/core @actions/github crypto

      - name: Load previous feedback
        id: load-previous
        run: |
          FEEDBACK_FILE=".github/workflows/review-state/feedback-${{ github.event.pull_request.number }}.json"

          if [ -f "$FEEDBACK_FILE" ]; then
            echo "Previous feedback found"
            echo "previous_feedback=$(cat $FEEDBACK_FILE | jq -c .)" >> $GITHUB_OUTPUT
          else
            echo "No previous feedback (first iteration)"
            echo "previous_feedback={}" >> $GITHUB_OUTPUT
          fi

      - name: Compare with previous iteration
        id: compare
        env:
          CURRENT_FEEDBACK_JSON: ${{ needs.collect-feedback.outputs.feedback_json }}
          PREVIOUS_FEEDBACK_JSON: ${{ steps.load-previous.outputs.previous_feedback }}
        run: node .github/scripts/compare-feedback.js

      - name: Save current feedback for next iteration
        run: |
          mkdir -p .github/workflows/review-state
          echo '${{ needs.collect-feedback.outputs.feedback_json }}' > \
            .github/workflows/review-state/feedback-${{ github.event.pull_request.number }}.json

      - name: Commit feedback state
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .github/workflows/review-state/
          git commit -m "chore: Update review feedback state [skip ci]" || echo "No changes to commit"
          git push origin ${{ github.event.pull_request.head.ref }}

      - name: Log comparison result
        run: |
          echo "=== Comparison Result ==="
          echo "Result: ${{ steps.compare.outputs.result }}"
          echo "Reason: ${{ steps.compare.outputs.reason }}"
          echo "Should fix: ${{ steps.compare.outputs.should_fix }}"
          echo "Current hash: ${{ steps.compare.outputs.current_hash }}"

  apply-fixes:
    name: Apply Claude Code Fixes
    runs-on: ubuntu-latest
    needs: [collect-feedback, detect-changes]
    if: needs.detect-changes.outputs.should_fix == 'true'
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          fetch-depth: 0

      - name: Format feedback for Claude
        id: format-prompt
        run: |
          cat << 'EOF' > /tmp/claude-prompt.txt
          The following AI code review bots have provided feedback on PR #${{ github.event.pull_request.number }}.

          Please analyze each piece of feedback and determine:
          1. Is this a legitimate issue that needs fixing?
          2. Does it violate CORTEX project standards or introduce bugs?
          3. Is it a stylistic preference that can be ignored?

          For legitimate issues, implement the fixes and create a commit.
          For invalid feedback, explain why you're ignoring it.

          ---

          ${{ needs.collect-feedback.outputs.feedback_summary }}

          ---

          Instructions:
          - Only fix actual bugs, security issues, or CORTEX standard violations
          - Ignore subjective style preferences unless they violate CLAUDE.md
          - Use ultrathink to analyze each suggestion carefully
          - Create a single commit with all fixes
          - Format commit message as: "fix: Address code review feedback from bots"
          EOF

          echo "prompt<<EOF" >> $GITHUB_OUTPUT
          cat /tmp/claude-prompt.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Invoke Claude Code to analyze and fix
        uses: anthropics/claude-code-action@v1
        with:
          # OAuth token (Pro/Max users): Run `claude setup-token` locally
          # API key fallback: Add ANTHROPIC_API_KEY secret
          oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          prompt: ${{ steps.format-prompt.outputs.prompt }}
          auto_commit: true
          commit_message: "fix: Address code review feedback from automated bots"

      - name: Notify success
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `✅ **Automated fixes applied**\n\nClaude Code has analyzed the bot feedback and applied fixes.\n\n**Comparison**: ${{ needs.detect-changes.outputs.reason }}\n\nThe bots will be triggered again to verify the fixes.`
            });

      - name: Notify failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `❌ **Automated fix workflow failed**\n\nClaude Code encountered an error while attempting to fix the issues.\n\nPlease review the workflow logs and address manually:\n${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}`
            });
            core.setFailed('Claude Code automated fixes failed');

  finalize:
    name: Finalize Review Cycle
    runs-on: ubuntu-latest
    needs: [collect-feedback, detect-changes]
    if: needs.detect-changes.outputs.result != 'new-issues'
    steps:
      - name: Post completion comment
        uses: actions/github-script@v7
        with:
          script: |
            const result = '${{ needs.detect-changes.outputs.result }}';
            let message = '';

            if (result === 'no-issues') {
              message = `✅ **Multi-agent review complete - No issues found!**\n\nAll review bots have analyzed the PR and found no issues.\n\nHash: \`${{ needs.detect-changes.outputs.current_hash }}\``;
            } else if (result === 'same-issues') {
              message = `⚠️ **Review loop detected - Stopping automation**\n\nThe feedback is identical to the previous iteration. Manual intervention required.\n\nReason: ${{ needs.detect-changes.outputs.reason }}\n\nHash: \`${{ needs.detect-changes.outputs.current_hash }}\``;
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: message
            });
